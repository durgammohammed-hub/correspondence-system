<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Tajawal', sans-serif; direction: rtl; background: #f8fafc; }
        
        .header {
            background: white; border-bottom: 1px solid #e5e7eb; padding: 16px 24px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .header-title { display: flex; align-items: center; gap: 12px; }
        .logo {
            width: 48px; height: 48px;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            border-radius: 12px; display: flex; align-items: center; justify-content: center;
        }
        .logo svg { width: 28px; height: 28px; color: white; }
        h1 { font-size: 20px; font-weight: 900; color: #111827; }
        
        .btn-back {
            background: #f3f4f6; border: none; padding: 10px 20px; border-radius: 10px;
            cursor: pointer; font-family: 'Tajawal', sans-serif; font-size: 14px;
            font-weight: 700; color: #374151;
        }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 32px; }
        
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px; margin-bottom: 24px;
        }
        
        .stat-card {
            background: white; padding: 20px; border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06); cursor: pointer; transition: all 0.3s;
        }
        
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .stat-card.active { border: 2px solid #3b82f6; background: #eff6ff; }
        
        .stat-value { font-size: 28px; font-weight: 900; color: #111827; margin-bottom: 4px; }
        .stat-label { font-size: 13px; color: #6b7280; font-weight: 600; }
        
        .card {
            background: white; border-radius: 16px; padding: 28px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        }
        
        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid #e5e7eb;
        }
        
        .card-title { font-size: 20px; font-weight: 800; color: #111827; }
        
        .btn {
            padding: 10px 20px; border: none; border-radius: 8px;
            font-family: 'Tajawal', sans-serif; font-size: 14px; font-weight: 700;
            cursor: pointer; transition: all 0.3s;
        }
        
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        
        .filters {
            display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;
        }
        
        .filter-input {
            flex: 1; min-width: 250px; padding: 10px 16px; border: 2px solid #e5e7eb;
            border-radius: 8px; font-family: 'Tajawal', sans-serif; font-size: 14px;
        }
        
        .filter-select {
            padding: 10px 16px; border: 2px solid #e5e7eb; border-radius: 8px;
            font-family: 'Tajawal', sans-serif; font-size: 14px; min-width: 150px;
        }
        
        .corr-list { display: flex; flex-direction: column; gap: 16px; }
        
        .corr-item {
            background: white; border: 2px solid #e5e7eb; border-radius: 12px;
            padding: 20px; cursor: pointer; transition: all 0.3s;
        }
        
        .corr-item:hover { border-color: #3b82f6; background: #f9fafb; }
        
        .corr-header {
            display: flex; justify-content: space-between; align-items: start;
            margin-bottom: 12px;
        }
        
        .corr-title { font-size: 16px; font-weight: 700; color: #111827; margin-bottom: 4px; }
        .corr-number { font-size: 13px; color: #6b7280; }
        
        .badge {
            display: inline-block; padding: 4px 12px; border-radius: 20px;
            font-size: 12px; font-weight: 700;
        }
        
        .badge-pending { background: #fef3c7; color: #92400e; }
        .badge-approved { background: #d1fae5; color: #065f46; }
        .badge-rejected { background: #fee2e2; color: #991b1b; }
        .badge-urgent { background: #fee2e2; color: #991b1b; }
        .badge-normal { background: #e5e7eb; color: #374151; }
        
        .corr-meta {
            display: flex; gap: 20px; font-size: 13px; color: #6b7280;
            padding-top: 12px; border-top: 1px solid #e5e7eb;
        }
        
        .empty-state {
            text-align: center; padding: 60px 20px; color: #9ca3af;
        }
        
        .loading { text-align: center; padding: 40px; color: #6b7280; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-title">
            <div class="logo">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
            </div>
            <div>
                <h1>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©</h1>
                <div style="font-size: 12px; color: #6b7280; font-weight: 600;">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª</div>
            </div>
        </div>
        <button class="btn-back" onclick="window.location.href='dashboard.html'">â† Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
    </div>
    
    <div class="container">
        <div class="stats-grid">
            <div class="stat-card active" id="filterAll" onclick="filterByType('all')">
                <div class="stat-value" id="totalAll">0</div>
                <div class="stat-label">ğŸ“‹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª</div>
            </div>
            
            <div class="stat-card" id="filterInbox" onclick="filterByType('inbox')">
                <div class="stat-value" id="totalInbox">0</div>
                <div class="stat-label">ğŸ“¥ Ø§Ù„ÙˆØ§Ø±Ø¯</div>
            </div>
            
            <div class="stat-card" id="filterSent" onclick="filterByType('sent')">
                <div class="stat-value" id="totalSent">0</div>
                <div class="stat-label">ğŸ“¤ Ø§Ù„ØµØ§Ø¯Ø±</div>
            </div>
            
            <div class="stat-card" id="filterPending" onclick="filterByType('pending')">
                <div class="stat-value" id="totalPending">0</div>
                <div class="stat-label">â³ Ù…Ø¹Ù„Ù‚Ø©</div>
            </div>
            
            <div class="stat-card" id="filterApproved" onclick="filterByType('approved')">
                <div class="stat-value" id="totalApproved">0</div>
                <div class="stat-label">âœ… Ù…Ø¹ØªÙ…Ø¯Ø©</div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h3 class="card-title" id="pageTitle">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª</h3>
                <button class="btn btn-primary" onclick="window.location.href='new-correspondence.html'">+ Ù…Ø±Ø§Ø³Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
            </div>
            
            <div class="filters">
                <input type="text" class="filter-input" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© Ø£Ùˆ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹..." id="searchInput" oninput="applyFilters()">
                
                <select class="filter-select" id="statusFilter" onchange="applyFilters()">
                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                    <option value="pending">Ù…Ø¹Ù„Ù‚Ø©</option>
                    <option value="in_progress">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</option>
                    <option value="approved">Ù…Ø¹ØªÙ…Ø¯Ø©</option>
                    <option value="rejected">Ù…Ø±ÙÙˆØ¶Ø©</option>
                </select>
                
                <select class="filter-select" id="priorityFilter" onchange="applyFilters()">
                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ§Øª</option>
                    <option value="urgent">Ø¹Ø§Ø¬Ù„Ø©</option>
                    <option value="important">Ù…Ù‡Ù…Ø©</option>
                    <option value="normal">Ø¹Ø§Ø¯ÙŠØ©</option>
                </select>
            </div>
            
            <div class="corr-list" id="corrList">
                <div class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            </div>
        </div>
    </div>
    
    <script>
const API_URL = `${window.location.origin}/api`;
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        
        if (!token) window.location.href = 'login.html';
        
        let allCorrs = [];
        let currentType = 'all';
        
        async function loadData() {
            try {
                const res = await fetch(`${API_URL}/correspondences`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (res.ok) {
                    const data = await res.json();
                    allCorrs = data.data || [];
                    updateStats();
                    displayCorrespondences();
                }
            } catch (e) {
                console.error(e);
                showEmpty('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„');
            }
        }
        
        function updateStats() {
            document.getElementById('totalAll').textContent = allCorrs.length;
            document.getElementById('totalInbox').textContent = allCorrs.filter(c => c.receiver_id == user.id).length;
            document.getElementById('totalSent').textContent = allCorrs.filter(c => c.sender_id == user.id).length;
            document.getElementById('totalPending').textContent = allCorrs.filter(c => c.status === 'pending').length;
            document.getElementById('totalApproved').textContent = allCorrs.filter(c => c.status === 'approved').length;
        }
        
        function filterByType(type) {
            currentType = type;
            
            document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
            document.getElementById('filter' + type.charAt(0).toUpperCase() + type.slice(1)).classList.add('active');
            
            const titles = {
                all: 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª',
                inbox: 'ğŸ“¥ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ÙˆØ§Ø±Ø¯',
                sent: 'ğŸ“¤ Ø§Ù„ØµØ§Ø¯Ø±',
                pending: 'â³ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©',
                approved: 'âœ… Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©'
            };
            
            document.getElementById('pageTitle').textContent = titles[type];
            applyFilters();
        }
        
        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;
            const priority = document.getElementById('priorityFilter').value;
            
            let filtered = allCorrs;
            
            // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
            if (currentType === 'inbox') filtered = filtered.filter(c => c.receiver_id == user.id);
            else if (currentType === 'sent') filtered = filtered.filter(c => c.sender_id == user.id);
            else if (currentType === 'pending') filtered = filtered.filter(c => c.status === 'pending');
            else if (currentType === 'approved') filtered = filtered.filter(c => c.status === 'approved');
            
            // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø­Ø«
            if (search) {
                filtered = filtered.filter(c => 
                    (c.corr_number && c.corr_number.toLowerCase().includes(search)) ||
                    (c.subject && c.subject.toLowerCase().includes(search))
                );
            }
            
            // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
            if (status) filtered = filtered.filter(c => c.status === status);
            
            // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©
            if (priority) filtered = filtered.filter(c => c.priority === priority);
            
            displayCorrespondences(filtered);
        }
        
        function displayCorrespondences(corrs = allCorrs) {
            const list = document.getElementById('corrList');
            
            if (!corrs.length) {
                showEmpty('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±Ø§Ø³Ù„Ø§Øª');
                return;
            }
            
            list.innerHTML = corrs.map(c => {
                const statusMap = {
                    draft: 'Ù…Ø³ÙˆØ¯Ø©',
                    pending: 'Ù…Ø¹Ù„Ù‚Ø©',
                    in_progress: 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©',
                    approved: 'Ù…Ø¹ØªÙ…Ø¯Ø©',
                    rejected: 'Ù…Ø±ÙÙˆØ¶Ø©'
                };
                
                const priorityMap = {
                    urgent: 'Ø¹Ø§Ø¬Ù„Ø©',
                    important: 'Ù…Ù‡Ù…Ø©',
                    normal: 'Ø¹Ø§Ø¯ÙŠØ©'
                };
                
                return `
                    <div class="corr-item" onclick="window.location.href='correspondence-details.html?id=${c.id}'">
                        <div class="corr-header">
                            <div style="flex:1;">
                                <div class="corr-title">${c.subject || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}</div>
                                <div class="corr-number">Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø©: ${c.corr_number || c.id}</div>
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <span class="badge badge-${c.status}">${statusMap[c.status] || c.status}</span>
                                <span class="badge badge-${c.priority}">${priorityMap[c.priority] || c.priority}</span>
                            </div>
                        </div>
                        
                        <div class="corr-meta">
                            <span>ğŸ‘¤ Ù…Ù†: ${c.sender_name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</span>
                            <span>ğŸ“© Ø¥Ù„Ù‰: ${c.receiver_name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</span>
                            <span>ğŸ“… ${new Date(c.created_at).toLocaleDateString('ar-IQ')}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function showEmpty(msg) {
            document.getElementById('corrList').innerHTML = `
                <div class="empty-state">${msg}</div>
            `;
        }
        
        window.addEventListener('load', loadData);
    </script>
</body>
</html>
