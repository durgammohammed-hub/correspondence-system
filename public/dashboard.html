<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Tajawal', sans-serif; direction: rtl; background: #f8fafc; }
        
        .header {
            background: white; border-bottom: 1px solid #e5e7eb; padding: 16px 24px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .header-title { display: flex; align-items: center; gap: 12px; }
        .logo {
            width: 48px; height: 48px;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            border-radius: 12px; display: flex; align-items: center; justify-content: center;
        }
        h1 { font-size: 20px; font-weight: 900; color: #111827; }
        
        .user-info { display: flex; align-items: center; gap: 16px; }
        .user-badge {
            background: #f3f4f6; padding: 8px 16px; border-radius: 12px;
            display: flex; align-items: center; gap: 12px;
        }
        .user-avatar {
            width: 40px; height: 40px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 10px; display: flex; align-items: center; justify-content: center;
            color: white; font-weight: 800; font-size: 16px;
        }
        .user-name { font-size: 14px; font-weight: 700; color: #111827; }
        .user-role { font-size: 12px; color: #6b7280; }
        
        .btn-logout {
            background: #ef4444; color: white; border: none;
            padding: 8px 16px; border-radius: 8px; cursor: pointer;
            font-family: 'Tajawal', sans-serif; font-size: 13px; font-weight: 700;
        }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 32px; }
        
        .welcome-section {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white; padding: 32px; border-radius: 20px; margin-bottom: 32px;
            box-shadow: 0 10px 40px rgba(59, 130, 246, 0.3);
        }
        
        .welcome-title { font-size: 28px; font-weight: 900; margin-bottom: 8px; }
        .welcome-subtitle { font-size: 16px; opacity: 0.9; }
        
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px; margin-bottom: 32px;
        }
        
        .stat-card {
            background: white; padding: 24px; border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06); cursor: pointer;
            transition: all 0.3s; border-right: 5px solid;
        }
        
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(0,0,0,0.12); }
        
        .stat-header { display: flex; justify-content: space-between; align-items: start; }
        .stat-label { font-size: 14px; color: #6b7280; font-weight: 600; margin-bottom: 8px; }
        .stat-value { font-size: 36px; font-weight: 900; }
        
        .stat-icon {
            width: 56px; height: 56px; border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
        }
        
        .section-title {
            font-size: 22px; font-weight: 800; color: #111827;
            margin: 32px 0 20px 0; padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .features-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .feature-card {
            background: white; padding: 24px; border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06); cursor: pointer;
            transition: all 0.3s; border: 2px solid transparent;
        }
        
        .feature-card:hover {
            transform: translateY(-4px); box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            border-color: #3b82f6;
        }
        
        .feature-icon {
            width: 56px; height: 56px; background: #eff6ff; border-radius: 14px;
            display: flex; align-items: center; justify-content: center; margin-bottom: 16px;
        }
        .feature-icon svg { width: 28px; height: 28px; color: #3b82f6; }
        .feature-title { font-size: 18px; font-weight: 800; color: #111827; margin-bottom: 8px; }
        .feature-desc { font-size: 14px; color: #6b7280; }
        
        /* My Correspondences Section */
        .my-corr-section {
            background: white;
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            margin-top: 32px;
        }
        
        .corr-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .corr-table th,
        .corr-table td {
            padding: 14px 12px;
            text-align: right;
            border-bottom: 1px solid #e5e7eb;
            font-size: 13px;
        }
        
        .corr-table th {
            background: #f9fafb;
            font-weight: 700;
            color: #374151;
        }
        
        .corr-table tr:hover {
            background: #f9fafb;
        }
        
        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            display: inline-block;
        }
        
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-info { background: #dbeafe; color: #1e40af; }
        
        /* Workflow Stages */
        .workflow-stages {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
            margin-top: 8px;
        }
        
        .stage {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            padding: 6px 12px;
            border-radius: 8px;
            background: white;
            border: 2px solid #e5e7eb;
        }
        
        .stage.completed {
            background: #d1fae5;
            border-color: #10b981;
            color: #065f46;
        }
        
        .stage.current {
            background: #fef3c7;
            border-color: #f59e0b;
            color: #92400e;
            font-weight: 700;
        }
        
        .stage.pending {
            background: white;
            border-color: #e5e7eb;
            color: #9ca3af;
        }
        
        .stage-icon {
            font-size: 14px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .admin-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .admin-card .feature-icon {
            background: rgba(255,255,255,0.2);
        }
        
        .admin-card .feature-icon svg {
            color: white;
        }
        
        .admin-card .feature-title,
        .admin-card .feature-desc {
            color: white;
        }
        
        .admin-card:hover {
            border-color: transparent;
            transform: translateY(-4px) scale(1.02);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-title">
            <div class="logo">ğŸ“§</div>
            <h1>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©</h1>
        </div>
        <div class="user-info">
            <div class="user-badge">
                <div class="user-avatar" id="userAvatar">A</div>
                <div>
                    <div class="user-name" id="userName">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
                    <div class="user-role" id="userRole">...</div>
                </div>
            </div>
            <button class="btn-logout" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>
    
    <div class="container">
        <div class="welcome-section">
            <div class="welcome-title" id="welcomeMsg">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ!</div>
            <div class="welcome-subtitle">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª Ø§Ù„Ø±Ø³Ù…ÙŠØ© - Ø¥Ø¯Ø§Ø±Ø© ÙƒØ§Ù…Ù„Ø© Ù„Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª ÙˆØ§Ù„ÙƒØªØ¨ Ø§Ù„Ø±Ø³Ù…ÙŠØ©</div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card" style="border-color: #3b82f6;" onclick="window.location.href='correspondences.html'">
                <div class="stat-header">
                    <div>
                        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª</div>
                        <div class="stat-value" style="color: #3b82f6;" id="totalCorr">0</div>
                    </div>
                    <div class="stat-icon" style="background: #eff6ff;">
                        <svg style="width: 28px; height: 28px; color: #3b82f6;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </div>
                </div>
            </div>
            
            <div class="stat-card" style="border-color: #10b981;" onclick="filterCorrespondences('completed')">
                <div class="stat-header">
                    <div>
                        <div class="stat-label">Ø§Ù„Ù…Ù†Ø¬Ø²Ø©</div>
                        <div class="stat-value" style="color: #10b981;" id="completedCorr">0</div>
                    </div>
                    <div class="stat-icon" style="background: #d1fae5;">
                        <svg style="width: 28px; height: 28px; color: #10b981;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                </div>
            </div>
            
            <div class="stat-card" style="border-color: #f59e0b;" onclick="filterCorrespondences('pending')">
                <div class="stat-header">
                    <div>
                        <div class="stat-label">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</div>
                        <div class="stat-value" style="color: #f59e0b;" id="pendingCorr">0</div>
                    </div>
                    <div class="stat-icon" style="background: #fef3c7;">
                        <svg style="width: 28px; height: 28px; color: #f59e0b;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                </div>
            </div>
            
            <div class="stat-card" style="border-color: #ef4444;" onclick="filterCorrespondences('urgent')">
                <div class="stat-header">
                    <div>
                        <div class="stat-label">Ø§Ù„Ø¹Ø§Ø¬Ù„Ø©</div>
                        <div class="stat-value" style="color: #ef4444;" id="urgentCorr">0</div>
                    </div>
                    <div class="stat-icon" style="background: #fee2e2;">
                        <svg style="width: 28px; height: 28px; color: #ef4444;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                    </div>
                </div>
            </div>
            
            <div class="stat-card" style="border-color: #8b5cf6;" onclick="showMyCorrespondences()">
                <div class="stat-header">
                    <div>
                        <div class="stat-label">Ù…Ø±Ø§Ø³Ù„Ø§ØªÙŠ</div>
                        <div class="stat-value" style="color: #8b5cf6;" id="myCorr">0</div>
                    </div>
                    <div class="stat-icon" style="background: #f3e8ff;">
                        <svg style="width: 28px; height: 28px; color: #8b5cf6;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>
        
        <h3 class="section-title">Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</h3>
        <div class="features-grid">
            <div class="feature-card" onclick="window.location.href='new-correspondence.html'">
                <div class="feature-icon">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                </div>
                <div class="feature-title">Ù…Ø±Ø§Ø³Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</div>
                <div class="feature-desc">Ø¥Ù†Ø´Ø§Ø¡ ÙƒØªØ§Ø¨ Ø±Ø³Ù…ÙŠ Ø¬Ø¯ÙŠØ¯</div>
            </div>
            
            <div class="feature-card" onclick="window.location.href='correspondences.html'">
                <div class="feature-icon">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                    </svg>
                </div>
                <div class="feature-title">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª</div>
                <div class="feature-desc">Ø¹Ø±Ø¶ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª</div>
            </div>
            
            <div class="feature-card" onclick="window.location.href='reports.html'">
                <div class="feature-icon">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                </div>
                <div class="feature-title">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
                <div class="feature-desc">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØªÙ‚Ø§Ø±ÙŠØ± Ø´Ø§Ù…Ù„Ø©</div>
            </div>
            
            <div class="feature-card" onclick="window.location.href='archive.html'">
                <div class="feature-icon">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                    </svg>
                </div>
                <div class="feature-title">Ø§Ù„Ø£Ø±Ø´ÙŠÙ</div>
                <div class="feature-desc">Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ©</div>
            </div>
            
            <div class="feature-card" onclick="window.location.href='signatures.html'">
                <div class="feature-icon">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                    </svg>
                </div>
                <div class="feature-title">Ø§Ù„ØªÙˆÙ‚ÙŠØ¹Ø§Øª</div>
                <div class="feature-desc">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙˆÙ‚ÙŠØ¹Ø§Øª Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</div>
            </div>
            
            <div class="feature-card" onclick="window.location.href='account-settings.html'">
                <div class="feature-icon">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                </div>
                <div class="feature-title">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</div>
                <div class="feature-desc">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
            </div>
            
            <div class="feature-card admin-card" onclick="window.location.href='admin.html'">
                <div class="feature-icon">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                    </svg>
                </div>
                <div class="feature-title">âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</div>
                <div class="feature-desc">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† â€¢ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… â€¢ Ø§Ù„Ø´Ø¹Ø¨ â€¢ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±</div>
            </div>
        </div>
        
        <!-- My Correspondences Section -->
        <div class="my-corr-section" id="myCorrSection" style="display: none;">
            <h3 class="section-title" style="margin-top: 0;">ğŸ“¤ Ù…Ø±Ø§Ø³Ù„Ø§ØªÙŠ - ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø±Ø§Ø­Ù„</h3>
            <div id="myCorrContent">
                <div class="loading">
                    <div class="spinner"></div>
                    Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø±Ø§Ø³Ù„Ø§ØªÙƒ...
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_URL = 'http://localhost:5000/api';
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        
        if (!token) {
            window.location.href = 'login.html';
        }
        
        // Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        document.getElementById('userName').textContent = user.full_name || 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
        document.getElementById('userRole').textContent = user.role_name_ar || 'Ù…ÙˆØ¸Ù';
        document.getElementById('userAvatar').textContent = (user.full_name || 'A').charAt(0);
        document.getElementById('welcomeMsg').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${user.full_name || 'Ø¨Ùƒ'}!`;
        
        let allCorrespondences = [];
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}/correspondences`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    allCorrespondences = data.data || [];
                    
                    document.getElementById('totalCorr').textContent = allCorrespondences.length;
                    
                    const completed = allCorrespondences.filter(c => c.status === 'approved').length;
                    document.getElementById('completedCorr').textContent = completed;
                    
                    const pending = allCorrespondences.filter(c => 
                        c.status === 'pending' || c.status === 'in_progress'
                    ).length;
                    document.getElementById('pendingCorr').textContent = pending;
                    
                    const urgent = allCorrespondences.filter(c => c.priority === 'urgent').length;
                    document.getElementById('urgentCorr').textContent = urgent;
                    
                    const myCorr = allCorrespondences.filter(c => c.created_by === user.id).length;
                    document.getElementById('myCorr').textContent = myCorr;
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        function filterCorrespondences(filter) {
            if (filter === 'completed') {
                window.location.href = 'correspondences.html?status=approved';
            } else if (filter === 'pending') {
                window.location.href = 'correspondences.html?status=pending';
            } else if (filter === 'urgent') {
                window.location.href = 'correspondences.html?priority=urgent';
            }
        }
        
        async function showMyCorrespondences() {
            const section = document.getElementById('myCorrSection');
            const content = document.getElementById('myCorrContent');
            
            // Toggle visibility
            if (section.style.display === 'block') {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Load my correspondences
            try {
                const myCorr = allCorrespondences.filter(c => c.created_by === user.id);
                
                if (!myCorr.length) {
                    content.innerHTML = '<div class="empty-state">Ù„Ù… ØªØ±Ø³Ù„ Ø£ÙŠ Ù…Ø±Ø§Ø³Ù„Ø§Øª Ø¨Ø¹Ø¯</div>';
                    return;
                }
                
                // Get workflow stages for each correspondence
                const corrWithStages = await Promise.all(myCorr.map(async (c) => {
                    try {
                        const res = await fetch(`${API_URL}/correspondences/${c.id}/workflow`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        
                        if (res.ok) {
                            const data = await res.json();
                            c.stages = data.data || [];
                        } else {
                            c.stages = [];
                        }
                    } catch (e) {
                        c.stages = [];
                    }
                    return c;
                }));
                
                displayMyCorrespondences(corrWithStages);
            } catch (error) {
                console.error(error);
                content.innerHTML = '<div class="empty-state" style="color: #ef4444;">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>';
            }
        }
        
        function displayMyCorrespondences(correspondences) {
            const content = document.getElementById('myCorrContent');
            
            const html = `
                <table class="corr-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                            <th>Ø§Ù„Ù†ÙˆØ¹</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ù…Ø±Ø§Ø­Ù„</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${correspondences.map(c => {
                            const statusBadge = getStatusBadge(c.status);
                            const stages = renderStages(c.stages);
                            
                            return `
                                <tr onclick="window.location.href='correspondence.html?id=${c.id}'" style="cursor: pointer;">
                                    <td>${c.id}</td>
                                    <td><strong>${c.subject}</strong></td>
                                    <td>${c.type_name || c.correspondence_type}</td>
                                    <td>${statusBadge}</td>
                                    <td>${new Date(c.created_at).toLocaleDateString('ar-IQ')}</td>
                                    <td>${stages}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            content.innerHTML = html;
        }
        
        function getStatusBadge(status) {
            const statuses = {
                'draft': { label: 'Ù…Ø³ÙˆØ¯Ø©', class: 'badge-info' },
                'pending': { label: 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©', class: 'badge-warning' },
                'in_progress': { label: 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©', class: 'badge-warning' },
                'approved': { label: 'Ù…Ø¹ØªÙ…Ø¯Ø©', class: 'badge-success' },
                'rejected': { label: 'Ù…Ø±ÙÙˆØ¶Ø©', class: 'badge-danger' },
                'archived': { label: 'Ù…Ø¤Ø±Ø´ÙØ©', class: 'badge-info' }
            };
            
            const s = statuses[status] || { label: status, class: 'badge-info' };
            return `<span class="badge ${s.class}">${s.label}</span>`;
        }
        
        function renderStages(stages) {
            if (!stages || !stages.length) {
                return '<span class="badge badge-info">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±Ø§Ø­Ù„</span>';
            }
            
            const html = stages.slice(0, 3).map(stage => {
                let stageClass = 'pending';
                let icon = 'â—‹';
                
                if (stage.status === 'completed' || stage.approved_at) {
                    stageClass = 'completed';
                    icon = 'âœ“';
                } else if (stage.status === 'in_progress' || stage.assigned_at) {
                    stageClass = 'current';
                    icon = 'â—';
                }
                
                return `<span class="stage ${stageClass}"><span class="stage-icon">${icon}</span>${stage.stage_name}</span>`;
            }).join('');
            
            return `<div class="workflow-stages">${html}</div>`;
        }
        
        function logout() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = 'login.html';
            }
        }
        
        window.addEventListener('load', loadStats);
    </script>
</body>
</html>
