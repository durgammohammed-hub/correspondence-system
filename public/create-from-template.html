<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±Ø§Ø³Ù„Ø© Ù…Ù† Ù‚Ø§Ù„Ø¨ - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Tajawal', sans-serif; direction: rtl; background: #f8fafc; }
        
        .header {
            background: white; border-bottom: 1px solid #e5e7eb; padding: 16px 24px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .header-title { display: flex; align-items: center; gap: 12px; }
        h1 { font-size: 20px; font-weight: 900; color: #111827; }
        
        .btn-back {
            background: #f3f4f6; border: none; padding: 10px 20px; border-radius: 10px;
            cursor: pointer; font-family: 'Tajawal', sans-serif; font-size: 14px;
            font-weight: 700; color: #374151; text-decoration: none;
        }
        
        .container { max-width: 1000px; margin: 0 auto; padding: 32px; }
        
        .steps {
            display: flex; justify-content: center; gap: 24px;
            margin-bottom: 40px;
        }
        
        .step {
            display: flex; align-items: center; gap: 12px;
            padding: 16px 24px; background: white;
            border-radius: 12px; border: 2px solid #e5e7eb;
        }
        
        .step.active {
            border-color: #3b82f6; background: #eff6ff;
        }
        
        .step.completed {
            border-color: #10b981; background: #f0fdf4;
        }
        
        .step-number {
            width: 32px; height: 32px; border-radius: 50%;
            background: #e5e7eb; display: flex; align-items: center;
            justify-content: center; font-weight: 900;
            color: #6b7280;
        }
        
        .step.active .step-number {
            background: #3b82f6; color: white;
        }
        
        .step.completed .step-number {
            background: #10b981; color: white;
        }
        
        .step-label {
            font-weight: 700; color: #6b7280;
        }
        
        .step.active .step-label {
            color: #3b82f6;
        }
        
        .step.completed .step-label {
            color: #10b981;
        }
        
        .card {
            background: white; border-radius: 16px; padding: 32px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        }
        
        .card-title {
            font-size: 22px; font-weight: 900; color: #111827;
            margin-bottom: 24px;
        }
        
        .templates-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .template-card {
            padding: 24px; border: 2px solid #e5e7eb;
            border-radius: 12px; cursor: pointer;
            transition: all 0.3s; text-align: center;
        }
        
        .template-card:hover {
            border-color: #3b82f6; background: #eff6ff;
            transform: translateY(-4px);
        }
        
        .template-card.selected {
            border-color: #3b82f6; background: #eff6ff;
        }
        
        .template-icon {
            font-size: 48px; margin-bottom: 12px;
        }
        
        .template-name {
            font-size: 16px; font-weight: 700;
            color: #111827; margin-bottom: 4px;
        }
        
        .template-desc {
            font-size: 13px; color: #6b7280;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block; font-weight: 700; color: #374151;
            margin-bottom: 8px; font-size: 14px;
        }
        
        .required { color: #ef4444; }
        
        .form-control, .form-select {
            width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb;
            border-radius: 8px; font-family: 'Tajawal', sans-serif;
            font-size: 14px; transition: all 0.3s;
        }
        
        .form-control:focus, .form-select:focus {
            outline: none; border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        textarea.form-control {
            resize: vertical; min-height: 100px;
        }
        
        .form-grid {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        .btn {
            padding: 12px 24px; border: none; border-radius: 8px;
            font-family: 'Tajawal', sans-serif; font-size: 14px;
            font-weight: 700; cursor: pointer; transition: all 0.3s;
        }
        
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover { background: #4b5563; }
        
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        
        .actions {
            display: flex; gap: 12px; justify-content: flex-end;
            margin-top: 32px; padding-top: 32px;
            border-top: 2px solid #e5e7eb;
        }
        
        .hidden { display: none; }
        
        .field-hint {
            font-size: 12px; color: #9ca3af;
            margin-top: 4px;
        }
        
        .preview-box {
            background: #f9fafb; padding: 20px;
            border-radius: 12px; border: 2px solid #e5e7eb;
            margin-bottom: 20px;
        }
        
        .preview-title {
            font-size: 16px; font-weight: 700;
            color: #374151; margin-bottom: 12px;
        }
        
        .preview-content {
            line-height: 1.8; white-space: pre-wrap;
            color: #111827;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-title">
            <div style="font-size: 32px;">ğŸ“</div>
            <h1>Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±Ø§Ø³Ù„Ø© Ù…Ù† Ù‚Ø§Ù„Ø¨</h1>
        </div>
        <a href="dashboard.html" class="btn-back">â† Ø§Ù„Ø¹ÙˆØ¯Ø©</a>
    </div>
    
    <div class="container">
        <!-- Steps -->
        <div class="steps">
            <div class="step active" id="step1">
                <div class="step-number">1</div>
                <div class="step-label">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø§Ù„Ø¨</div>
            </div>
            <div class="step" id="step2">
                <div class="step-number">2</div>
                <div class="step-label">ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
            </div>
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <div class="step-label">Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ§Ù„Ø¥Ø±Ø³Ø§Ù„</div>
            </div>
        </div>
        
        <!-- Step 1: Template Selection -->
        <div class="card" id="templateSelection">
            <div class="card-title">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨</div>
            
            <div class="templates-grid" id="templatesGrid">
                <!-- Will be populated by JS -->
            </div>
            
            <div class="actions">
                <button class="btn btn-primary" onclick="nextStep()" disabled id="nextBtn1">
                    Ø§Ù„ØªØ§Ù„ÙŠ â†
                </button>
            </div>
        </div>
        
        <!-- Step 2: Fill Data -->
        <div class="card hidden" id="dataEntry">
            <div class="card-title">ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø§Ù„Ø¨</div>
            
            <form id="templateForm">
                <div id="dynamicFields">
                    <!-- Will be populated based on selected template -->
                </div>
                
                <div class="actions">
                    <button type="button" class="btn btn-secondary" onclick="prevStep()">
                        â†’ Ø§Ù„Ø³Ø§Ø¨Ù‚
                    </button>
                    <button type="button" class="btn btn-primary" onclick="nextStep()">
                        Ø§Ù„ØªØ§Ù„ÙŠ â†
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Step 3: Review and Submit -->
        <div class="card hidden" id="review">
            <div class="card-title">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ÙƒØªØ§Ø¨</div>
            
            <div class="preview-box">
                <div class="preview-title">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙƒØªØ§Ø¨:</div>
                <div class="preview-content" id="previewContent">
                    <!-- Will show filled template -->
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Ø§Ù„Ù…Ø±Ø³Ù„ Ø¥Ù„ÙŠÙ‡ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ <span class="required">*</span></label>
                <select class="form-select" id="finalRecipient" required>
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø³Ù„ Ø¥Ù„ÙŠÙ‡</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Ù†Ø³Ø®Ø© Ø¥Ù„Ù‰ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <div id="ccCheckboxes"></div>
            </div>
            
            <div class="actions">
                <button type="button" class="btn btn-secondary" onclick="prevStep()">
                    â†’ Ø§Ù„Ø³Ø§Ø¨Ù‚
                </button>
                <button type="button" class="btn btn-success" onclick="submitCorrespondence()">
                    âœ‰ï¸ Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø§Ø¹ØªÙ…Ø§Ø¯
                </button>
            </div>
        </div>
    </div>
    
    <script>
        const API_URL = 'http://localhost:5000/api';
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        
        if (!token) {
            window.location.href = 'login.html';
        }
        
        let currentStep = 1;
        let selectedTemplate = null;
        let formData = {};
        
        // Template definitions with fields
        const templates = [
            {
                id: 1,
                name: 'ÙƒØªØ§Ø¨ Ø±Ø³Ù…ÙŠ Ø¹Ø§Ù…',
                icon: 'ğŸ“‹',
                description: 'Ù‚Ø§Ù„Ø¨ ÙƒØªØ§Ø¨ Ø±Ø³Ù…ÙŠ Ø¹Ø§Ù…',
                fields: [
                    { name: 'subject', label: 'Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹', type: 'text', required: true },
                    { name: 'recipient_name', label: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„ Ø¥Ù„ÙŠÙ‡', type: 'text', required: true },
                    { name: 'recipient_position', label: 'Ù…Ù†ØµØ¨ Ø§Ù„Ù…Ø±Ø³Ù„ Ø¥Ù„ÙŠÙ‡', type: 'text', required: true },
                    { name: 'content', label: 'Ø§Ù„Ù…Ø­ØªÙˆÙ‰', type: 'textarea', required: true },
                    { name: 'attachments_note', label: 'Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª', type: 'text', required: false }
                ],
                template: `Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±ÙŠØ© Ø§Ù„Ø¹Ø±Ø§Ù‚ÙŠØ©
ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ±Ø¨ÙŠØ©
{{department}}

Ø§Ù„Ø¹Ø¯Ø¯: {{number}}
Ø§Ù„ØªØ§Ø±ÙŠØ®: {{date}}

Ø¥Ù„Ù‰: {{recipient_name}}
      {{recipient_position}}

Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹: {{subject}}

ØªØ­ÙŠØ© Ø·ÙŠØ¨Ø©ØŒ

{{content}}

Ù…Ø¹ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ØŒ

{{sender_name}}
{{sender_position}}
Ø§Ù„ØªÙˆÙ‚ÙŠØ¹: ________________`
            },
            {
                id: 2,
                name: 'Ø·Ù„Ø¨ Ø¥Ø¬Ø§Ø²Ø©',
                icon: 'ğŸ–ï¸',
                description: 'Ù‚Ø§Ù„Ø¨ Ø·Ù„Ø¨ Ø¥Ø¬Ø§Ø²Ø© Ø§Ø¹ØªÙŠØ§Ø¯ÙŠØ©',
                fields: [
                    { name: 'leave_type', label: 'Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©', type: 'select', 
                      options: ['Ø§Ø¹ØªÙŠØ§Ø¯ÙŠØ©', 'Ù…Ø±Ø¶ÙŠØ©', 'Ø·Ø§Ø±Ø¦Ø©'], required: true },
                    { name: 'leave_duration', label: 'Ø§Ù„Ù…Ø¯Ø© (Ø¨Ø§Ù„Ø£ÙŠØ§Ù…)', type: 'number', required: true },
                    { name: 'leave_start', label: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©', type: 'date', required: true },
                    { name: 'leave_end', label: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©', type: 'date', required: true },
                    { name: 'leave_reason', label: 'Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©', type: 'textarea', required: true }
                ],
                template: `Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±ÙŠØ© Ø§Ù„Ø¹Ø±Ø§Ù‚ÙŠØ©
ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ±Ø¨ÙŠØ©
{{department}}

Ø§Ù„Ø¹Ø¯Ø¯: {{number}}
Ø§Ù„ØªØ§Ø±ÙŠØ®: {{date}}

Ø¥Ù„Ù‰: Ù…Ø¯ÙŠØ± Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ© Ø§Ù„Ù…Ø­ØªØ±Ù…

Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹: Ø·Ù„Ø¨ Ø¥Ø¬Ø§Ø²Ø© {{leave_type}}

ØªØ­ÙŠØ© Ø·ÙŠØ¨Ø©ØŒ

Ø£ØªÙ‚Ø¯Ù… Ø¨Ø·Ù„Ø¨ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø¬Ø§Ø²Ø© {{leave_type}} Ù„Ù…Ø¯Ø© {{leave_duration}} ÙŠÙˆÙ…ØŒ Ù…Ù† ØªØ§Ø±ÙŠØ® {{leave_start}} Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ® {{leave_end}}.

Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©:
{{leave_reason}}

Ø¢Ù…Ù„ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø·Ù„Ø¨ÙŠ Ù‡Ø°Ø§.

Ù…Ø¹ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ØŒ

{{sender_name}}
{{sender_position}}`
            },
            {
                id: 3,
                name: 'Ù…Ø­Ø¶Ø± Ø§Ø¬ØªÙ…Ø§Ø¹',
                icon: 'ğŸ‘¥',
                description: 'Ù‚Ø§Ù„Ø¨ Ù…Ø­Ø¶Ø± Ø§Ø¬ØªÙ…Ø§Ø¹ Ø±Ø³Ù…ÙŠ',
                fields: [
                    { name: 'meeting_title', label: 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹', type: 'text', required: true },
                    { name: 'meeting_date', label: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹', type: 'date', required: true },
                    { name: 'meeting_time', label: 'ÙˆÙ‚Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹', type: 'time', required: true },
                    { name: 'meeting_location', label: 'Ù…ÙƒØ§Ù† Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹', type: 'text', required: true },
                    { name: 'attendees', label: 'Ø§Ù„Ø­Ø§Ø¶Ø±ÙˆÙ†', type: 'textarea', required: true },
                    { name: 'agenda', label: 'Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„', type: 'textarea', required: true },
                    { name: 'discussions', label: 'Ø§Ù„Ù…Ù†Ø§Ù‚Ø´Ø§Øª', type: 'textarea', required: true },
                    { name: 'decisions', label: 'Ø§Ù„Ù‚Ø±Ø§Ø±Ø§Øª', type: 'textarea', required: true }
                ],
                template: `Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±ÙŠØ© Ø§Ù„Ø¹Ø±Ø§Ù‚ÙŠØ©
ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ±Ø¨ÙŠØ©
{{department}}

Ù…Ø­Ø¶Ø± Ø§Ø¬ØªÙ…Ø§Ø¹

Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: {{meeting_title}}
Ø§Ù„ØªØ§Ø±ÙŠØ®: {{meeting_date}}
Ø§Ù„ÙˆÙ‚Øª: {{meeting_time}}
Ø§Ù„Ù…ÙƒØ§Ù†: {{meeting_location}}

Ø§Ù„Ø­Ø§Ø¶Ø±ÙˆÙ†:
{{attendees}}

Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„:
{{agenda}}

Ø§Ù„Ù…Ù†Ø§Ù‚Ø´Ø§Øª:
{{discussions}}

Ø§Ù„Ù‚Ø±Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ®Ø°Ø©:
{{decisions}}

Ø§Ù„ØªÙˆÙ‚ÙŠØ¹Ø§Øª:
Ø±Ø¦ÙŠØ³ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹: ________________
Ø§Ù„Ù…Ù‚Ø±Ø±: ________________`
            }
        ];
        
        window.addEventListener('load', () => {
            displayTemplates();
            loadRecipients();
            loadCCOptions();
        });
        
        function displayTemplates() {
            const grid = document.getElementById('templatesGrid');
            
            grid.innerHTML = templates.map(t => `
                <div class="template-card" onclick="selectTemplate(${t.id})">
                    <div class="template-icon">${t.icon}</div>
                    <div class="template-name">${t.name}</div>
                    <div class="template-desc">${t.description}</div>
                </div>
            `).join('');
        }
        
        function selectTemplate(id) {
            selectedTemplate = templates.find(t => t.id === id);
            
            // Update UI
            document.querySelectorAll('.template-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            document.getElementById('nextBtn1').disabled = false;
        }
        
        function nextStep() {
            if (currentStep === 1) {
                if (!selectedTemplate) return;
                generateDynamicFields();
                currentStep = 2;
            } else if (currentStep === 2) {
                if (!validateForm()) return;
                collectFormData();
                generatePreview();
                currentStep = 3;
            }
            
            updateStepsUI();
        }
        
        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepsUI();
            }
        }
        
        function updateStepsUI() {
            // Update step indicators
            for (let i = 1; i <= 3; i++) {
                const step = document.getElementById(`step${i}`);
                step.classList.remove('active', 'completed');
                
                if (i === currentStep) {
                    step.classList.add('active');
                } else if (i < currentStep) {
                    step.classList.add('completed');
                }
            }
            
            // Show/hide sections
            document.getElementById('templateSelection').classList.toggle('hidden', currentStep !== 1);
            document.getElementById('dataEntry').classList.toggle('hidden', currentStep !== 2);
            document.getElementById('review').classList.toggle('hidden', currentStep !== 3);
        }
        
        function generateDynamicFields() {
            const container = document.getElementById('dynamicFields');
            
            container.innerHTML = selectedTemplate.fields.map(field => {
                if (field.type === 'text' || field.type === 'number' || field.type === 'date' || field.type === 'time') {
                    return `
                        <div class="form-group">
                            <label class="form-label">
                                ${field.label}
                                ${field.required ? '<span class="required">*</span>' : ''}
                            </label>
                            <input type="${field.type}" class="form-control" 
                                   name="${field.name}" ${field.required ? 'required' : ''}>
                        </div>
                    `;
                } else if (field.type === 'textarea') {
                    return `
                        <div class="form-group">
                            <label class="form-label">
                                ${field.label}
                                ${field.required ? '<span class="required">*</span>' : ''}
                            </label>
                            <textarea class="form-control" name="${field.name}" 
                                      ${field.required ? 'required' : ''}></textarea>
                        </div>
                    `;
                } else if (field.type === 'select') {
                    return `
                        <div class="form-group">
                            <label class="form-label">
                                ${field.label}
                                ${field.required ? '<span class="required">*</span>' : ''}
                            </label>
                            <select class="form-select" name="${field.name}" 
                                    ${field.required ? 'required' : ''}>
                                <option value="">Ø§Ø®ØªØ±...</option>
                                ${field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                            </select>
                        </div>
                    `;
                }
            }).join('');
        }
        
        function validateForm() {
            const form = document.getElementById('templateForm');
            return form.checkValidity();
        }
        
        function collectFormData() {
            const form = document.getElementById('templateForm');
            const inputs = form.querySelectorAll('input, textarea, select');
            
            formData = {
                template_id: selectedTemplate.id,
                template_name: selectedTemplate.name
            };
            
            inputs.forEach(input => {
                formData[input.name] = input.value;
            });
        }
        
        function generatePreview() {
            let content = selectedTemplate.template;
            
            // Replace placeholders
            const today = new Date().toLocaleDateString('ar-IQ');
            const year = new Date().getFullYear();
            
            content = content.replace('{{number}}', `___/${year}`);
            content = content.replace('{{date}}', today);
            content = content.replace('{{department}}', user.dept_name || 'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©');
            content = content.replace('{{sender_name}}', user.full_name);
            content = content.replace('{{sender_position}}', user.role_name_ar || 'Ù…ÙˆØ¸Ù');
            
            // Replace user-filled fields
            Object.keys(formData).forEach(key => {
                const placeholder = `{{${key}}}`;
                content = content.replace(new RegExp(placeholder, 'g'), formData[key] || '');
            });
            
            document.getElementById('previewContent').textContent = content;
        }
        
        async function loadRecipients() {
            try {
                const response = await fetch(`${API_URL}/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const managers = data.data.filter(u => u.level && u.level <= 3);
                    const select = document.getElementById('finalRecipient');
                    
                    managers.forEach(u => {
                        const option = document.createElement('option');
                        option.value = u.id;
                        option.textContent = `${u.full_name} - ${u.role_name_ar || 'Ù…Ø¯ÙŠØ±'}`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error(error);
            }
        }
        
        function loadCCOptions() {
            const container = document.getElementById('ccCheckboxes');
            const options = ['Ø§Ù„Ø£Ø±Ø´ÙŠÙ', 'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©', 'Ø´Ø¹Ø¨Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©', 'Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©'];
            
            container.innerHTML = options.map(opt => `
                <label style="display: block; margin-bottom: 8px;">
                    <input type="checkbox" name="cc" value="${opt}" style="margin-left: 8px;">
                    ${opt}
                </label>
            `).join('');
        }
        
        async function submitCorrespondence() {
            const recipient = document.getElementById('finalRecipient').value;
            if (!recipient) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø±Ø³Ù„ Ø¥Ù„ÙŠÙ‡ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ');
                return;
            }
            
            // Collect CC
            const ccCheckboxes = document.querySelectorAll('input[name="cc"]:checked');
            const cc = Array.from(ccCheckboxes).map(cb => cb.value);
            
            const finalContent = document.getElementById('previewContent').textContent;
            
            const payload = {
                corr_type: 'ØµØ§Ø¯Ø±',
                subject: formData.subject || selectedTemplate.name,
                content: finalContent,
                priority: 'normal',
                recipient_id: recipient,
                template_id: selectedTemplate.id,
                template_data: JSON.stringify(formData),
                cc: cc
            };
            
            try {
                const response = await fetch(`${API_URL}/correspondences`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    alert('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© Ù„Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­');
                    window.location.href = 'correspondences.html';
                } else {
                    const error = await response.json();
                    alert('âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ' + (error.error || ''));
                }
            } catch (error) {
                console.error(error);
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            }
        }
    </script>
</body>
</html>
